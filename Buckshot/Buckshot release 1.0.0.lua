local map = '<C><P L="1600" H="600" D="x_transformice/x_evt/x_evt_18/sdnjqj/ninja.jpg,0,0" MEDATA=";;;;-0;0:::1-"/><Z><S><S T="9" X="1514" Y="401" L="178" H="392" P="0,0,0,0,0,0,0,0" m=""/><S T="0" X="805" Y="617" L="1600" H="40" P="0,0,0.3,0.2,0,0,0,0" m=""/><S T="0" X="20" Y="120" L="40" H="1000" P="0,0,0,0,0,0,0,0" m=""/><S T="0" X="1580" Y="120" L="40" H="1000" P="0,0,0,0,0,0,0,0" m=""/><S T="0" X="1105" Y="316" L="214" H="23" P="0,0,0.3,0.2,0,0,0,0" m=""/><S T="0" X="1518" Y="479" L="98" H="24" P="0,0,0.3,0.2,0,0,0,0" m=""/><S T="0" X="1496" Y="574" L="140" H="43" P="0,0,0.3,0.2,0,0,0,0" m=""/><S T="0" X="1526" Y="414" L="80" H="103" P="0,0,0.3,0.2,0,0,0,0" m=""/><S T="0" X="1543" Y="288" L="48" H="148" P="0,0,0.3,0.2,0,0,0,0" m=""/><S T="0" X="1474" Y="433" L="24" H="33" P="0,0,0.3,0.2,0,0,0,0" m=""/><S T="0" X="1291" Y="244" L="200" H="21" P="0,0,0.3,0.2,0,0,0,0" m=""/><S T="0" X="793" Y="270" L="247" H="21" P="0,0,0.3,0.2,2,0,0,0" m=""/><S T="0" X="224" Y="265" L="449" H="24" P="0,0,0.3,0.2,0,0,0,0" m=""/><S T="1" X="447" Y="297" L="20" H="69" P="0,0,0,0.2,-10,0,0,0" m=""/><S T="1" X="464" Y="329" L="20" H="69" P="0,0,0,0.2,-40,0,0,0" m=""/><S T="1" X="485" Y="342" L="20" H="69" P="0,0,0,0.2,-70,0,0,0" m=""/><S T="1" X="500" Y="344" L="20" H="69" P="0,0,0,0.2,-90,0,0,0" m=""/><S T="1" X="511" Y="339" L="20" H="46" P="0,0,0,0.2,-130,0,0,0" m=""/><S T="0" X="1530" Y="545" L="152" H="80" P="0,0,0.3,0.2,20,0,0,0" m=""/><S T="0" X="760" Y="440" L="316" H="80" P="0,0,0.3,0.2,0,0,0,0" m=""/><S T="0" X="862" Y="197" L="52" H="43" P="0,0,0.3,0.2,0,0,0,0" m=""/><S T="0" X="766" Y="127" L="114" H="22" P="0,0,0.3,0.2,0,0,0,0" m=""/><S T="0" X="571" Y="173" L="77" H="17" P="0,0,0.3,0.2,0,0,0,0" m=""/><S T="1" X="352" Y="89" L="20" H="69" P="0,0,0,0.2,-10,0,0,0" m=""/><S T="1" X="369" Y="121" L="20" H="69" P="0,0,0,0.2,-40,0,0,0" m=""/><S T="1" X="390" Y="134" L="20" H="69" P="0,0,0,0.2,-70,0,0,0" m=""/><S T="1" X="405" Y="136" L="20" H="69" P="0,0,0,0.2,-90,0,0,0" m=""/><S T="1" X="422" Y="138" L="39" H="46" P="0,0,0,0.2,-130,0,0,0" m=""/><S T="0" X="227" Y="62" L="252" H="15" P="0,0,0.3,0.2,0,0,0,0" m=""/><S T="0" X="72" Y="43" L="59" H="44" P="0,0,0.3,0.2,0,0,0,0" m=""/><S T="0" X="87" Y="29" L="35" H="18" P="0,0,0.3,0.2,-40,0,0,0" m=""/><S T="0" X="52" Y="29" L="35" H="18" P="0,0,0.3,0.2,40,0,0,0" m=""/><S T="0" X="946" Y="82" L="70" H="22" P="0,0,0.3,0.2,0,0,0,0" m=""/><S T="13" X="1109" Y="707" L="174" P="0,0,0.3,0.2,0,0,0,0" o="324650" m=""/></S><D><DS X="805" Y="587"/></D><O/><L/></Z></C>'

local images = {
    [1] = {desc = "bullet 1", link ="18d94efd992", w = 70, h = 36},
    [2] = {desc = "bullet 2", link ="17913d9d7f1", w = 30, h = 30},
    [3] = {desc = "coffins", link ="18a856a9fc4", w = 512, h = 452},
    [4] = {desc = "energy", link ="188f4dda81f", w = 30, h = 30},
    [5] = {desc = "knife", link ="18b53fbd2c8", w = 60, h = 60},
    [6] = {desc = "coke", link ="155c4c32b34", w = 40, h = 53},
    [7] = {desc = "life", link ="17913d97a2d", w = 30, h = 30},
    [8] = {desc = "heart", link ="184256e5c4c", w = 69, h = 69},
    [9] = {desc = "green apple", link ="185c2d9ec5a", w = 40, h = 40},
    [10] = {desc = "frozen mice", link ="185c2dfb727", w = 61, h = 61},
    [11] = {desc = "cheese", link ="168c3845081", w = 48, h = 29},
    [12] = {desc = "battery", link ="17935528c97", w = 30, h = 30},
    [13] = {desc = "Search", link ="16f7cf485c3", w = 25, h = 25},
    [14] = {desc = "Broken screen", link ="17cb7f114d3", w = 800, h = 400},
    [15] = {desc = "background 1", link ="177fc32305e.jpg", w = 4800, h = 800},
    [16] = {desc = "chair", link ="1507c491936", w = 30, h = 41},
    [17] = {desc = "table", link ="150c9f48c07", w = 176, h = 40},
    [18] = {desc = "Close 1", link ="171e178660d", w = 22, h = 22},
    [19] ={desc = "Help 1", link ="1860ee33630", w = 51, h = 51},
}

local pixeis = {
    [1] = {desc = "Red pixel", link ="17948d9ecc2", w = 1, h = 1},
    [2] = {desc = "Green pixel", link ="17948da0435", w = 1, h = 1},
    [3] =  {desc = "Blue pixel", link ="17948da1ba8", w = 1, h = 1},
    [4] = {desc = "Black pixel", link ="17948da3319", w = 1, h = 1},
    [5] = {desc = "White pixel", link ="17948da4a89", w = 1, h = 1},
    [6] = {desc = "Unknow 1 pixel", link ="17ced628ce3", w = 1, h = 1},
    [7] = {desc = "Orange pixel", link ="1856d827d2c", w = 1, h = 1},
    [8] = {desc = "Yellow pixel", link ="17ced62db05", w = 1, h = 1},
    [9] = {desc = "Light gray pixel", link ="17ced630392", w = 1, h = 1},
    [10] = {desc = "Light brown pixel", link ="17ced631b00", w = 1, h = 1},
    [11] = {desc = "Pink pixel", link ="185c24c2740", w = 1, h = 1},
    [12] = {desc = "Dark brown pixel", link ="17ced6349e3", w = 1, h = 1},
    [13] = {desc = "Purple pixel", link ="185c2462102", w = 1, h = 1},
    [14] = {desc = "Acqua pixel", link ="1856dbd863a", w = 1, h = 1},
    [15] = {desc = "Yellow pixel 1", link ="1856d8d212d", w = 1, h = 1},
    [16] = {desc = "Yellow pixel 2", link ="1856d889e44", w = 1, h = 1},
}
local dev = { "Devillorde#1090", "Desolate#2367" }
local popups, data, containers, games = {}, {}, {}, {}
local popupIndex, popupCooldown = 0, 5
local items = {{img = images[3], name = images[3].desc, href = "perk_freeze", info = "Coffins will freeze the target for 1 round"}, {img = images[5], name = images[5].desc, href = "perk_double", info = "Knife will double damage if is a real bullet"}, {img = images[6], name = images[6].desc, href = "perk_reload", info = "Will replace the current bullet for another"}, {img = images[7], name = images[7].desc, href = "perk_life", info = "Adds one life if not full nor in critical condition"}, {img = images[13], name = images[13].desc, href = "perk_reveal", info = "Reveals the current bullet"}} -- os index dos perks que vão gerar aleatoriamente
local sound = {letal = 'bouboum/x_explosion_6', fake = 'cite18/allumette', double = 'cite18/foudre2', reload = 'fortoresse/x_recharge_fin', reveal ='bouboum/x_bonus', life = 'cite18/maudit', freeze = 'transformice/son/gel', unfreeze = 'tfmadv/elixir', knife = 'cite18/epee'}
function fitOrientation(b, s, cB, cS)
    cB = type(cB) == "string" and ((tonumber(cB) >= 0 and tonumber(cB) <= 99.9) and b + (s * (tonumber(cB)/100)) or b + (s * .99)) or cB < 0 and (b + s <= math.abs(cB) and b or b + s + cB) or cB >= b + s and (b + s) - 10 or b + cB
    cS = type(cS) == "string" and ((tonumber(cS) >= 0 and tonumber(cS) <= 99.9) and (s * (tonumber(cS)/100) > (b + s) - cB and s - (cB - b) or s * (tonumber(cS)/100)) or s - (cB - b)) or cS == 0 and s - (cB - b) or cS < 0 and (s < math.abs(cS) and s - (cB - b) or (s + cS) - (cB-b) ) or cB + cS > b + s and s - (cB - b) or cS
    return cB, cS
end
function newComponent(t)
    t = t and t or {}
    local component = {cpType = t.cpType and t.cpType or 0, selected = t.selected and t.selected or false, img = t.img and t.img or t.image and t.image or {desc = "404", link ="17948da1ba8", w = 1, h = 1}, imgTrue = t.imgTrue and t.imgTrue or nil, imgFalse = t.imgFalse and t.imgFalse or nil, text = t.text and t.text or t.txt and t.txt or "", font = t.font and t.font or nil, align = t.align and t.align or 'center', size = t.size and t.size or 16, color = t.color and t.color or "#FFFFFF", href = t.href and t.href or nil, x = t.x and t.x or 0, y = t.y and t.y or 0, w = t.w and t.w or 0, h = t.h and t.h or 0, alpha = t.alpha and t.alpha or 1, bg = t.bg and t.bg or 0x3F555A, border = t.border and t.border or 0x00DFFC, enabled = (t.enabled == true or t.enabled == nil) and true or false, xMirror = t.xMirror and t.xMirror or false, yMirror = t.yMirror and t.yMirror or false, type = t.type and t.type or 1, rotation = t.rotation and t.rotation or 0}
    return component
end
function containerAPI (containerName, t)
    t = t and t or {}
    local container = {name = containerName or "container: "..os.time(), cIds = 1, imgIDs = {}, components = {}, x = t.x or 0, y = t.y or 0, w = t.w or 800, h = t.h or 400, fixed = t.fixed or false,
        clear = function (self) self:setVisible(false) self.components = {} end,
        setVisible = function(self, show, playerName)
            local players = (playerName and type(playerName) == "table") and {} or playerName and {[playerName] = true} or tfm.get.room.playerList
            if playerName and type(playerName) == "table" then
                if #playerName == 0 then
                    players = playerName
                else for i = 1, #playerName do players[playerName[i]] = true end end
            end
            for p in pairs(players) do
                if show == true then
                    self:setVisible(false, p)
                    for i = 1, #self.components do
                        local c, cX, cY, cW, cH, evt = self.components[self.components[i]]
                        cX, cW = fitOrientation(self.x, self.w, c.x, c.w)
                        cY, cH = fitOrientation(self.y, self.h, c.y, c.h)
                        if c.cpType == 1 or c.cpType == 2 or (c.cpType == 6 and c.selected == true and c.imgTrue) or (c.cpType == 6 and c.selected == false and c.imgFalse) then
                            local img, imgFormat = (c.cpType == 6 and c.selected == true) and c.imgTrue or (c.cpType == 6 and c.selected == false) and c.imgFalse or c.img, string.find(((c.cpType == 6 and c.selected == true) and c.imgTrue.link or (c.cpType == 6 and c.selected == false) and c.imgFalse.link or c.img.link), "%p") and "" or ".png"
                            self.imgIDs[self.components[i]..p] = tfm.exec.addImage(img.link .. imgFormat, self.fixed == true and "_"..i or "~"..i,(c.xMirror and cX + cW or cX)+(cW*.5), (c.yMirror and cY + cH or cY)+(cH*.5), p, c.xMirror and (cW/img.w) * -1 or cW/img.w, c.yMirror and (cH/img.h) * -1 or cH/img.h, math.rad(c.rotation), c.alpha, .5, .5, true)
                        end if c.cpType == 2 or c.cpType == 3 or c.cpType == 6 then
                            ui.addTextArea(getPopupIndex(self.components[i]..p), "<p ".."align='"..c.align.."'".."><font "..(c.font and "face='"..c.font.."'" or "").." "..((c.cpType == 6 or c.cpType == 2) and "size='60'" or "size='"..c.size.."'").." ".."color='"..c.color.."'"..">"..((c.href and c.enabled == true) and "<a href='event:"..c.href.."'>" or "")..((c.cpType == 6 or c.cpType == 2) and "\n" or c.text)..((c.href and c.enabled == true) and "</a>" or "").."</font></p>", p, cX, cY, cW, cH, (c.cpType == 6 and c.selected == false) and 0xE30000 or (c.cpType == 6 and c.selected == true) and 0x12B801 or c.bg, c.cpType == 6 and 0x121212 or c.border, (c.cpType == 6 and c.selected == true and c.imgTrue) and 0 or (c.cpType == 6 and c.selected == false and c.imgFalse) and 0 or c.cpType == 2 and 0 or c.alpha, not self.fixed)
                        end if c.cpType == 4 then
                            ui.addPopup(getPopupIndex(self.components[i]..p), c.type, c.text, p, cX, cY, cW, not self.fixed)
                        end if c.cpType == 5 then
                            ui.showColorPicker (getPopupIndex(self.components[i]..p), p, c.color, c.text)
                        end
                    end
                else
                    for i = 1, #self.components do
                        if (self.components[self.components[i]].cpType == 1 or self.components[self.components[i]].cpType == 2 or self.components[self.components[i]].cpType == 6)  and self.imgIDs[self.components[i]..p] then
                            tfm.exec.removeImage(self.imgIDs[self.components[i]..p], true)
                        end if self.components[self.components[i]].cpType == 2 or self.components[self.components[i]].cpType == 3 or self.components[self.components[i]].cpType == 6 then
                            ui.removeTextArea(getPopupIndex(self.components[i]..p))
                        end if self.components[self.components[i]].cpType == 4 then
                            ui.addPopup(getPopupIndex(self.components[i]..p), 1, "", p, -1000, -1000, 10, true)
                        end
                    end
                end
            end
        end,
        register = function(self, type, t)
            local id = self.name..".component."..self.cIds self.cIds, t = self.cIds + 1, t and t or {} t.cpType = type
            self.components[id] = newComponent(t) table.insert(self.components, id)
            return self.components[id]
        end,
        addImage = function(self, t) return self:register(1, t) end,
        addButton = function(self, t) return self:register(2, t) end,
        addText = function(self, t) return self:register(3, t) end,
        addPopup = function(self, t) return self:register(4, t) end,
        addColorPicker = function(self, t) return self:register(5, t) end,
        addSwitch = function(self, t) return self:register(6, t) end}
    return container
end

function getPopupIndex(name, resetTimer)
    if popups[name] then
        if resetTimer then
            popups[name].cooldown = popupCooldown
        end
        return popups[name].id
    end
    popupIndex = popupIndex + 1
    popups[name] = {
        id = popupIndex,
        cooldown = popupCooldown
    }
    return popups[name].id
end

function getGameByPlayer(playerName)
    for gameId, game in pairs(games) do
        if game.players[1] == playerName or game.players[2] == playerName then
            return gameId
        end
    end
end

function init()
    for _, v in next, {"AfkDeath", "MortCommand", "AutoNewGame", "AutoShaman", "AutoTimeLeft", "AutoScore"} do
        tfm.exec['disable' .. v]()
    end
    system.disableChatCommandDisplay(nil, true)
    tfm.exec.newGame(map)
    initHUDs()
    for playerName, playerData in pairs(tfm.get.room.playerList) do
        eventNewPlayer(playerName)
    end
end

function initHUDs()
    brokenHUD = containerAPI("broken")
    brokenHUD:addImage({img = images[14]})
    shootChoiceHUD = containerAPI("shoot.choice", {x = 300, y = 100, w = 200, h = 200})
    shootChoiceHUD:addText({bg = 0x282828, border = 0x282828, alpha = 0.7})
    shootChoiceHUD:addText({text = "Enemy", href = "shoot_tantofaz", size = 30, y = 0, h = 40, alpha = 0})
    shootChoiceHUD:addText({text = "You", href = "shoot_you", size = 30, y = -40, h = 40, alpha = 0})
    blockScreenHUD = containerAPI("block.screen", {x = 0, y = 0, w = 800, h = 400})
    blockScreenHUD:addText({alpha = .2, bg = 0x282828, border = 0x282828})
    shootHUD = containerAPI("shoot", {x = 350, y = 350, w = 100, h = 30})
    shootHUD:addText({text = "Shoot", bg = 0x324650, alpha = 0.2, size = 18, href = "shoot"})
    helpHUD = containerAPI("help",{x = 100, y = 35, w = 600, h = 300})
    helpHUD:addText({alpha = .8, bg = 0x3b3535, border = 0x0f0f0f})
    helpHUD:addText({text = "Buckshot", x = "20", w = "60", h = 30, size = 20, alpha = 0})
    helpHUD:addImage({img = pixeis[5], x = 10, y = 30, w = -10, h = 2})
    local y = 35
    for i, j in pairs(items) do
        helpHUD:addImage({img = j.img, x = 10, y = y, w = 30, h = 30})
        helpHUD:addText({text = j.info, x = 45, y = y + 3, w = 0, h = 20, alpha = 0, size = 12, align = "left"})
        y = y + 32
    end
    helpHUD:addText({text = "Shooting yourself with a blank bullet makes it skip the other player's turn", x = 0, y = 200, h = 20, size = 12, alpha = 0, align = "left"})
    helpHUD:addText({text = "Two or less hearts makes the player get in a critical condition (fatal if hit again)", x = 0, y = 230, h = 20, size = 12, alpha = 0, align = "left"})
    helpHUD:addText({text = dev[1], y = -30, alpha = 0, size = 16, align = "left"})
    helpHUD:addText({text = dev[2], y = -30, alpha = 0, size = 16, align = "right"})
    helpHUD:addButton({img = images[18],x = -20, h = 20, href = "help_close"})
    helpIcon = containerAPI("help.icon", {x = 760, y = 35, w = 40, h = 40})
    helpIcon:addButton({img = images[19],x = 0, y = 0, w = 40, h = 40, href = "help_open"})
end

function eventNewPlayer(playerName)
    if not data[playerName] then
        --nada para manter, então reseta tudo msm
    end
    data[playerName] = {energy = {count = 6}, perks = {}, isPlaying = false, criticalCondition = false, frozen = 0, lost = 0}
    tfm.exec.setUIMapName("Roulette")
    tfm.exec.respawnPlayer(playerName)
    showInviteButton(playerName)
    helpHUD:setVisible(true, playerName)
    helpIcon:setVisible(true, playerName)
    --setBackground(playerName)
end

function eventPlayerLeft(playerName)
    local game = games[getGameByPlayer(playerName)]
    if game then
        local winner = game.players[1] == playerName and game.players[2] or game.players[1]
        game:endGame(winner)
    end
end

function eventPlayerDied(playerName)
    tfm.exec.respawnPlayer(playerName)
end

function eventLoop(currentTime, remainingTime)
    for gameId, game in pairs(games) do
        game.block.timer = game.block.timer >= 0.5 and game.block.timer - 0.5 or game.block.timer
        if game.block.timer == 8 then
            game.magazine.HUD:setVisible(false, game.players)
        end if game.block.timer <= 8 and game.block.timer % 2 == 0 then
            for i = 1, #game.players do
                if #data[game.players[i]].perks.showCase.items > 0 then
                    data[game.players[i]].perks.showCase.cp.img = data[game.players[i]].perks.showCase.items[1].img
                    table.remove(data[game.players[i]].perks.showCase.items, 1)
                    data[game.players[i]].perks.showCase.HUD:setVisible(true, game.players[i])
                end
            end
        end if game.block.timer == 0 then
            game.block.timer = -1
            blockScreenHUD:setVisible(false, game.players)
            data[game.players[1]].perks.showCase.HUD:setVisible(false, game.players[1])
            data[game.players[2]].perks.showCase.HUD:setVisible(false, game.players[2])
        end
    end
    for name, player in pairs(tfm.get.room.playerList) do
        data[name].lost = data[name].lost >= 0.5 and data[name].lost - 0.5 or data[name].lost
        if data[name].lost == 0 then
            data[name].lost = -1
            brokenHUD:setVisible(false, name)
        end
    end
end

function createGame(player1, player2)
    local game = {
        turn = math.random(2) == 1 and player1 or player2,
        players = {player1, player2},
        HUD = HUD,
        magazine = {},
        bullet = nil,
        shoot = {},
        block = {timer = 0},
        id = player1 .. "vs" .. player2,
        blockScreen = function(self)
            blockScreenHUD:setVisible(true, self.players)
            self.block.timer = 13
        end,
        endGame = function(self, winner)
            local loser = winner == self.players[1] and self.players[2] or self.players[1]

            for i = 1, #self.players do
                showInviteButton(self.players[i])
                data[self.players[i]].isPlaying = false
                data[self.players[i]].energy.count = 6
                data[self.players[i]].frozen = 0
                data[self.players[i]].lost = 0
                data[self.players[i]].criticalCondition = false
                data[self.players[i]].energy.HUD:setVisible(false)
                tfm.exec.freezePlayer(self.players[i], false)
                data[self.players[i]].perks.showCase.HUD:setVisible(false, self.players[i])
                --tfm.exec.killPlayer(self.players[i])
            end
            self.HUD:setVisible(false)
            shootHUD:setVisible(false)
            shootChoiceHUD:setVisible(false)
            blockScreenHUD:setVisible(false)
            self.magazine.HUD:setVisible(false)
            data[loser].lost = 5
            brokenHUD:setVisible(true, loser)
            games[self.id] = nil
            if winner then
                for i = 1, #self.players do
                    ui.addTextArea(getPopupIndex("info"), "<p align='center'><a href='event:info'><font size='18' color='#ffffff'>Player " .. winner .. " won the game</font></a></p>", self.players[i], 100, 200, 600, 0, 0x324650, 0x000000, 1, true)                
                end
            end
        end,
        generateRandomPerks = function(self)
            for i = 1, #self.players do
                local amount = 0
                for j = 1, 8 do
                    if not data[self.players[i]].perks[j].perk then -- analisa se ja tem um perk, se tiver, ele pula
                        local index = math.random(1, #items) -- pega um item aleatório da lista
                        data[self.players[i]].perks[j].perk = items[index]
                        amount = amount + 1
                        table.insert(data[self.players[i]].perks.showCase.items, items[index])
                    end
                    if amount == 4 then break end -- dá no maximo 4 perks para o player
                end
            end
        end,
        getBullet = function(self)
            local picked = math.random(#self.magazine.bullets)
            self.bullet = self.magazine.bullets[picked]
            table.remove(self.magazine.bullets, picked)
        end,
        getMagazine = function(self)
            local HUD = containerAPI(self.id..".magazine",{x = 100, y = 150, w = 600, h = 150})
            if self.magazine.HUD then
                self.magazine.HUD:setVisible(false)
            end
            self.magazine.HUD = HUD
            self.magazine.bullets = {}
            for i = 1, math.random(0,6) do
                table.insert(self.magazine.bullets, {power = math.random(0,1)})
            end
            table.insert(self.magazine.bullets, {power = 0})
            table.insert(self.magazine.bullets, {power = 1})
            HUD:addText({text = "", h = -50, alpha = 0.8, bg = 0x282828, border = 0x282828})
            local regionWidth, index, empty, full = 600 / (#self.magazine.bullets + 1), 1, 0, 0
            for i = 1, #self.magazine.bullets do
                local x = index * regionWidth
                if self.magazine.bullets[i].power == 1 then
                    HUD:addImage({img = pixeis[1], x = x - 20, y = 10, w = 40, h = -50})
                    full = full + 1
                else
                    HUD:addImage({img = pixeis[9], x = x - 20, y = 10, w = 40, h = -50})
                    empty = empty + 1
                end
                HUD:addImage({img = pixeis[16], x = x - 23, y = -80, w = 46, h = -50})
                HUD:addImage({img = pixeis[16], x = x - 25, y = -60, w = 50, h = -50})
                index = index + 1
            end
            HUD:addText({text = full.. " lives, "..empty.." blanks", y = -40})
            self:blockScreen()
            HUD:setVisible(true, self.players)
        end,
        playSound = function (self, sound)
            for i = 1, #self.players do
                tfm.exec.playSound(sound, 100, nil, nil, self.players[i])
            end
        end,
        shoot = function(self, shooter, choice)
            if choice then
                local target = choice == "you" and shooter or self.players[1] == shooter and self.players[2] or self.players[1]
                shootChoiceHUD:setVisible(false, shooter)
                self.turn = (self.bullet.power == 0 and target == shooter) and self.turn or self.players[1] == self.turn and self.players[2] or self.players[1]
                if self.turn ~= shooter then
                    for i = 1, #self.players do
                        if data[self.players[i]].frozen == 1 then
                            tfm.exec.freezePlayer(self.players[i], false, true)
                            self:playSound(sound.unfreeze)
                        end
                        data[self.players[i]].frozen = data[self.players[i]].frozen == 0 and 0 or data[self.players[i]].frozen - 1
                    end
                end
                if self.turn ~= shooter and data[self.turn].frozen > 0 and #self.magazine.bullets > 0 then
                    self.turn = self.players[1] == self.turn and self.players[2] or self.players[1]
                else
                    self.turn = self.players[1] == self.turn and self.players[1] or self.players[2]
                end
                self.turnText.text = "Current turn: ".. self.turn
                local targetP = tfm.get.room.playerList[target]
                if self.bullet.power == 0 then
                    self:playSound(sound.fake)
                    tfm.exec.displayParticle(3, targetP.x, targetP.y, 0, 1, 0, -1, self.players[1])
                    tfm.exec.displayParticle(3, targetP.x, targetP.y, 0, 1, 0, -1, self.players[2])
                elseif self.bullet.power == 1 then
                    self:playSound(sound.letal)
                    tfm.exec.displayParticle(30, targetP.x, targetP.y, 0, 1, 0, -1, self.players[1])
                    tfm.exec.displayParticle(30, targetP.x, targetP.y, 0, 1, 0, -1, self.players[2])
                elseif self.bullet.power == 2 then
                    self:playSound(sound.double)
                    tfm.exec.displayParticle(5, targetP.x, targetP.y, 0, 1, 0, -1, self.players[1])
                    tfm.exec.displayParticle(5, targetP.x, targetP.y, 0, 1, 0, -1, self.players[2])
                end
                for i = 1, self.bullet.power do
                    if data[target].energy.count > 2 then
                        data[target].energy.cp[data[target].energy.count].alpha = 0
                        data[target].energy.count = data[target].energy.count - 1
                    elseif data[target].criticalCondition == true then
                        if data[target].energy.cp[data[target].energy.count] then
                            data[target].energy.cp[data[target].energy.count].alpha = 0
                        end
                        data[target].energy.count = 0
                    end
                end
                self:updateHearts()
                if data[target].energy.count <= 2 and not data[target].criticalCondition then
                    data[target].criticalCondition = true
                    ui.addTextArea(getPopupIndex("info"), "<p align='center'><a href='event:info'><font size='18' color='#ffffff'>" .. target .. " is in a critical condition</font></a></p>", self.players[1], 100, 200, 600, 0, 0x324650, 0x000000, 1, true)
                    ui.addTextArea(getPopupIndex("info"), "<p align='center'><a href='event:info'><font size='18' color='#ffffff'>" .. target .. " is in a critical condition</font></a></p>", self.players[2], 100, 200, 600, 0, 0x324650, 0x000000, 1, true)
                end
                if data[target].energy.count == 0 then
                    local winner = target == self.players[1] and self.players[2] or self.players[1]
                    data[target].lost = 5
                    self:endGame(winner)
                    return
                end
                if #self.magazine.bullets > 0 then
                    self:getBullet()
                    self.HUD:setVisible(true, self.players)
                    shootHUD:setVisible(false, self.players)
                    shootHUD:setVisible(true, self.turn)
                else
                    self:startNewRound()
                end
            else
                shootChoiceHUD:setVisible(true, shooter)
            end
        end,
        startNewRound = function (self)
            self:generateRandomPerks()
            for i = 1, #self.players do
                local player = self.players[i]
                if data[player].frozen > 0 then
                    data[player].frozen = 0
                    tfm.exec.freezePlayer(player, false)
                    self:playSound(sound.unfreeze)
                end
            end
            self:updateHUD()
            shootHUD:setVisible(false)
            shootHUD:setVisible(true, self.turn)
            self:getMagazine()
            self:getBullet()
        end,
        updateHearts = function (self)
            for i = 1, #self.players do
                data[self.players[i]].energy.HUD:setVisible(true, self.players)
            end
        end,
        updateHUD = function(self)
            for i = 1, #self.players do
                data[self.players[i]].energy.HUD:setVisible(true,self.players)
                for j = 1, #data[self.players[i]].perks do
                    if data[self.players[i]].perks[j].perk then
                        data[self.players[i]].perks[j].cp.alpha = 1
                        data[self.players[i]].perks[j].cp.img = data[self.players[i]].perks[j].perk.img
                        data[self.players[i]].perks[j].cp.href = data[self.players[i]].perks[j].perk.href
                    end
                end
            end
            self.HUD:setVisible(true, self.players)
        end,
        usePerk = function (self, playerName, perkName)
            local hasPerk = false
            for i = 1, #data[playerName].perks do
                if data[playerName].perks[i].perk and string.find(data[playerName].perks[i].perk.href, perkName) then
                    hasPerk = true
                    break
                end
            end
            if not hasPerk then
                return
            end
            local reveal = false
            if perkName == "double" then
                self:playSound(sound.knife)
                self.bullet.power = self.bullet.power == 0 and 0 or 2
            elseif perkName == "reload" then
                if #self.magazine.bullets ~= 0 then
                    self:playSound(sound.reload)
                    ui.addTextArea(getPopupIndex("info"), "<p align='center'><a href='event:info'><font size='18' color='#ffffff'>".. (self.bullet.power == 1 and "Lethal bullet" or "Blank bullet").." wasted</font></a></p>", self.players[1], 100, 200, 600, 0, 0x324650, 0x000000, 1, true)
                    ui.addTextArea(getPopupIndex("info"), "<p align='center'><a href='event:info'><font size='18' color='#ffffff'>".. (self.bullet.power == 1 and "Lethal bullet" or "Blank bullet").." wasted</font></a></p>", self.players[2], 100, 200, 600, 0, 0x324650, 0x000000, 1, true)
                    self:getBullet()
                end
            elseif perkName == "life" then
                if data[playerName].energy.count > 2 and data[playerName].energy.count < 6 then
                    data[playerName].energy.count = data[playerName].energy.count + 1
                    data[playerName].energy.cp[data[playerName].energy.count].alpha = 0.8
                    self:updateHearts()
                    self:playSound(sound.life)
                end
            elseif perkName == "reveal" then
                self:playSound(sound.reveal)
                ui.addTextArea(getPopupIndex("info"), "<p align='center'><a href='event:info'><font size='18' color='#ffffff'>".."Current bullet: " .. (self.bullet.power == 1 and "Lethal bullet" or "Blank bullet").."</font></a></p>", playerName, 100, 200, 600, 0, 0x324650, 0x000000, 1, true)
            elseif perkName == "freeze" then
                local target = self.turn == self.players[1] and self.players[2] or self.players[1]
                data[target].frozen = data[target].frozen == 0 and 2 or data[target].frozen
                tfm.exec.freezePlayer(target, true, true)
                self:playSound(sound.freeze)
            end
            for i = 1, #data[playerName].perks do
                if data[playerName].perks[i].perk and string.find(data[playerName].perks[i].perk.href, perkName) then
                    data[playerName].perks[i].perk = nil
                    data[playerName].perks[i].cp.alpha = 0
                    data[playerName].perks[i].cp.href = nil
                    break
                end
            end
            self.HUD:setVisible(true, self.players)
            shootHUD:setVisible(true, self.turn)
        end
    }
    games[game.id] = game
    local x = 0
    for i = 1, #game.players do
        ui.removeTextArea(getPopupIndex("inviteButton_" .. game.players[i]), game.players[i])
        data[game.players[i]].energy.cp = {}
        data[game.players[i]].energy.HUD = containerAPI(game.players[i] .. ".energy", {x = i % 2 == 0 and 550 or 20, y = 75, w = 240, h = 30})
        data[game.players[i]].energy.HUD:addText({bg = 0x282828, border = 0x282828})
        for j = 1, 6 do
            data[game.players[i]].energy.cp[j] = data[game.players[i]].energy.HUD:addImage({img = images[8], x = i % 2 == 0 and 210 - x or x, w = 30, h = 30, alpha = 0.8})
            x = x + 40
        end
        for j = 1, 8 do
            data[game.players[i]].perks[j] = {}
        end
        data[game.players[i]].perks.showCase = {}
        data[game.players[i]].perks.showCase.items = {}
        data[game.players[i]].perks.showCase.HUD = containerAPI(game.players[i] .. ".showCase", {x = 0 , y = 25})
        data[game.players[i]].perks.showCase.HUD:addText({x = 300, y = 150, w = 200, h = 200, bg = 0x282828, border = 0x282828})
        data[game.players[i]].perks.showCase.cp = data[game.players[i]].perks.showCase.HUD:addImage({img=pixeis[2], x = 350, y = 200, w = 100, h = 100})
    end
    game.HUD = containerAPI(game.id .. "_Roulette", {x = 0, y = 0, w = 800, h = 400})
    game.turnText = game.HUD:addText({text = "Current turn: " .. game.turn, x = 268, y = 30, w = 272, h = 60, bg = 0x324650, alpha = 0.8, size = 20, bg = 0x282828, border = 0x282828}) 
    game.HUD:addText({text = player1, x = 20, y = 50, w = 200, h = 30, alpha = 0, align = "left", size = 16, bg = 0x282828, border = 0x282828})
    game.HUD:addText({text = player2, x = 590, y = 50, w = 200, h = 30, alpha = 0, align = "right", size = 16, bg = 0x282828, border = 0x282828})
    game:updateHearts()

    local player1PerkX, player2PerkX = 20, 710
    local player1PerkY, player2PerkY = 300, 300
    local player1PerkCount, player2PerkCount = 0, 0
    game.HUD:addText({x = 10, y = 290, w = 190, h = 100, alpha = 0.8, bg = 0x282828})
    game.HUD:addText({x = 600, y = 290, w = 190, h = 100, alpha = 0.8, bg = 0x282828})
    for i = 1, 8 do
        if i <= 4 then
            data[player1].perks[i].cp = game.HUD:addButton({x = player1PerkX + (player1PerkCount % 2) * 40, y = player1PerkY + math.floor(player1PerkCount / 2) * 50, w = 30, h = 30, alpha = 0})
            data[player2].perks[i].cp = game.HUD:addButton({x = player2PerkX + (player2PerkCount % 2) * 40, y = player2PerkY + math.floor(player2PerkCount / 2) * 50, w = 30, h = 30, alpha = 0})
        else
            data[player1].perks[i].cp = game.HUD:addButton({x = player1PerkX + 100 + ((player1PerkCount - 4) % 2) * 40, y = player1PerkY + math.floor((player1PerkCount - 4) / 2) * 50, w = 30, h = 30, alpha = 0})
            data[player2].perks[i].cp = game.HUD:addButton({x = player2PerkX - 100 + ((player2PerkCount - 4) % 2) * 40, y = player2PerkY + math.floor((player2PerkCount - 4) / 2) * 50, w = 30, h = 30, alpha = 0})
        end
        player1PerkCount, player2PerkCount = player1PerkCount + 1,player2PerkCount + 1
    end

    --[[for name, player in pairs(tfm.get.room.playerList) do
        if name == player1 or name == player2 then
        else
            tfm.exec.addImage('149a49e4b38.jpg', '%'..player1, 0, 0, name, 1, 1, 0, 0, 0, 0, false)
            tfm.exec.addImage('149a49e4b38.jpg', '%'..player2, 0, 0, name, 1, 1, 0, 0, 0, 0, false)
            tfm.exec.addImage('149a49e4b38.jpg', '%'..name, 0, 0, player1, 1, 1, 0, 0, 0, 0, false)
            tfm.exec.addImage('149a49e4b38.jpg', '%'..name, 0, 0, player2, 1, 1, 0, 0, 0, 0, false)
        end
    end--]]
    --tfm.exec.movePlayer(player1, 555, 700)
    --tfm.exec.movePlayer(player2, 1035, 700)
    game:startNewRound()
end

function setBackground(playerName)
    local backGround, chair, table = images[15], images[16], images[17]
    local imgFormat = string.find(backGround.link, "%p") and "" or ".png"
    tfm.exec.addImage(backGround.link..imgFormat, '?0', -200, 400, playerName, 2000/backGround.w, 460/backGround.h, 0, 1, 0, 0, false)
    imgFormat = string.find(table.link, "%p") and "" or ".png"
    tfm.exec.addImage(table.link..imgFormat, '?1', 650, 690, playerName, 300/table.w, 70/table.h, 0, 1, 0, 0, false)
    imgFormat = string.find(chair.link, "%p") and "" or ".png"
    tfm.exec.addImage(chair.link..imgFormat, '?2', 540, 720, playerName, 40/chair.w, 40/chair.h, 0, 1, 0, 0, false)
    tfm.exec.addImage(chair.link..imgFormat, '?3', 1020, 720, playerName, 40/chair.w, 40/chair.h, 0, 1, 0, 0, false)
end

function showInviteButton(playerName)
    ui.addTextArea(getPopupIndex("inviteButton_" .. playerName), "<p align='center'><a href='event:showInvite'><font size='18' color='#ffffff'>Invite</font></a></p>", playerName, 728, 150, 70, 30, 0x324650, 0x000000, 1, true)
end

function invitePlayer(inviterPlayer, invitedPlayer)
    local container = containerAPI("invitePopup".. invitedPlayer, {x = 200, y = 125, w = 368, h = 154})
    containers["invitePopup".. invitedPlayer] = container
    container:addText({text = "", x = 0, y = 0, w = 368, h = 154, bg = 0x324650, border = 0x000000, alpha = 0.8})
    container:addText({text = "Invite Menu", x = 0, y = 0, w = 368, h = 30, alpha = 0, size = 22})
    container:addText({text = inviterPlayer .. " has invited you to play", x = 0, y = 50, w = 368, h = 30, alpha = 0, size = 12})
    container:addText({text = "Accept", x = 50, y = 100, w = 120, h = 30, bg = 0x00A600, border = 0x000000, alpha = 1, size = 18, href = "acceptInvite_"..inviterPlayer})
    container:addText({text = "Decline", x = 200, y = 100, w = 120, h = 30, bg = 0xA60303, border = 0x000000, alpha = 1, href = "declineInvite", size = 18})

    container:setVisible(true, invitedPlayer)
end

function showAvailablePlayers(playerName)
    local container = containerAPI(playerName .. "_availablePlayers", {x = 250, y = 50, w = 300, h = 300})
    containers[playerName .. "_availablePlayers"] = container
    container:addText({text = "", x = 0, y = 0, w = 300, h = 300, bg = 0x3b3535, border = 0x0f0f0f, alpha = 0.5})
    container:addText({text = "Available Players", x = 0, y = 0, w = 300, h = 30, bg = 0x3b3535, border = 0x0f0f0f, size = 18})

    local yPos = 40
    for name, player in pairs(tfm.get.room.playerList) do
        if name ~= playerName and not data[name].isPlaying and player.isDead == false then
            container:addText({text = "Invite " .. name, x = 0, y = yPos, w = 300, h = 30, bg = 0x3b3535, border = 0x0f0f0f, alpha = 0.8, href = "invite_" .. name, size = 16})
            yPos = yPos + 40
        end
    end
    container:setVisible(true, playerName)
end

function eventTextAreaCallback(id, playerName, event)
    local args = {}
    for s in event:gmatch("([^_]+)") do
        table.insert(args, s)
    end
    if args[1] == "showInvite" then
        local container = containers[playerName .. "_availablePlayers"]
        if container then
            container:setVisible(false, playerName)
            containers[playerName .. "_availablePlayers"] = nil
        else
            showAvailablePlayers(playerName)
        end
    elseif args[1] == "acceptInvite" then
        if not data[playerName].isPlaying then
            createGame(args[2], playerName)
            data[playerName].isPlaying = true
            data[args[2]].isPlaying = true
            containers["invitePopup".. playerName]:setVisible(false, playerName)
            local container = containers[playerName .. "_availablePlayers"]
            if container then
                container:setVisible(false, playerName)
                containers[playerName .. "_availablePlayers"] = nil
            end
        end
    elseif args[1] == "declineInvite" then
        containers["invitePopup".. playerName]:setVisible(false, playerName)
    elseif args[1] == "invite" then
        invitePlayer(playerName, args[2])
        containers[playerName .. "_availablePlayers"]:setVisible(false, playerName)
    elseif args[1] == "shoot" then
        ui.removeTextArea(getPopupIndex("perk_reveal"), playerName)
        local game = games[getGameByPlayer(playerName)]
        if game and game.turn ~= playerName then
            return 
        end
        game:shoot(playerName,args[2])
    elseif args[1] == "perk" then
        local game = games[getGameByPlayer(playerName)]
        if game.turn ~= playerName then
            return 
        end
        game:usePerk(playerName, args[2])
    elseif args[1] == "info" then
        ui.removeTextArea(id, playerName)
    elseif args[1] == "help" then
        if args[2] == "close" then
            helpHUD:setVisible(false, playerName)
        elseif args[2] == "open" then
            helpHUD:setVisible(true, playerName)
        end
    end
end

init()
